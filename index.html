<script>
const ws = new WebSocket(`ws://${location.host}`);
let currentUser = '';
let activeChat = null;

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);

  if (data.type === 'users') {
    renderUserList(data.list);
  }

  if (data.type === 'message') {
    if (!chatMessages[data.from]) chatMessages[data.from] = [];
    chatMessages[data.from].push({ sender: data.from, text: data.text });
    if (activeChat?.otherUser === data.from) renderMessages();
  }
};

function joinNetwork() {
  const name = document.getElementById('nameInput').value.trim();
  if (!name) return alert('Please enter your name!');
  currentUser = name;
  ws.send(JSON.stringify({ type: 'join', name }));
  document.getElementById('nameInput').disabled = true;
  document.getElementById('userListSection').classList.remove('hidden');
}

function renderUserList(list) {
  const userListDiv = document.getElementById('userList');
  userListDiv.innerHTML = '';
  list.forEach(user => {
    const div = document.createElement('div');
    div.className = 'user-item' + (user === currentUser ? ' current-user' : '');
    const span = document.createElement('span');
    span.className = 'user-name';
    span.textContent = user;
    div.appendChild(span);
    if (user !== currentUser) {
      const btn = document.createElement('button');
      btn.className = 'connect-btn';
      btn.textContent = '[ CONNECT ]';
      btn.onclick = () => openChat(user);
      div.appendChild(btn);
    }
    userListDiv.appendChild(div);
  });
}

const chatMessages = {};

function openChat(otherUser) {
  activeChat = { otherUser };
  const existingChat = document.getElementById('activeChat');
  if (existingChat) existingChat.remove();
  const chatContainer = document.createElement('div');
  chatContainer.className = 'chat-container';
  chatContainer.id = 'activeChat';
  chatContainer.innerHTML = `
    <div class="chat-title-bar">
      <span>ðŸ’¬ CHAT WITH ${otherUser}</span>
      <button class="disconnect-btn" onclick="disconnectChat()">X</button>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-area">
      <input type="text" class="chat-input" id="messageInput" placeholder="Type message..." onkeypress="handleKeyPress(event)">
      <button class="send-btn" onclick="sendMessage()">[ SEND ]</button>
    </div>`;
  document.body.appendChild(chatContainer);
  renderMessages();
}

function renderMessages() {
  const messagesDiv = document.getElementById('chatMessages');
  messagesDiv.innerHTML = '';
  const msgs = chatMessages[activeChat.otherUser] || [];
  msgs.forEach(m => {
    const div = document.createElement('div');
    div.className = 'message ' + (m.sender === currentUser ? 'sent' : 'received');
    div.innerHTML = `<div class="message-sender">[${m.sender}]:</div><div class="message-content">${m.text}</div>`;
    messagesDiv.appendChild(div);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function sendMessage() {
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  if (!text) return;
  const msg = { sender: currentUser, text };
  if (!chatMessages[activeChat.otherUser]) chatMessages[activeChat.otherUser] = [];
  chatMessages[activeChat.otherUser].push(msg);
  renderMessages();
  ws.send(JSON.stringify({ type: 'message', from: currentUser, to: activeChat.otherUser, text }));
  input.value = '';
}

function handleKeyPress(event) {
  if (event.key === 'Enter') sendMessage();
}

function disconnectChat() {
  document.getElementById('activeChat')?.remove();
  activeChat = null;
}
</script>
